1. Удостоверяющие центры (CA)

Удостоверяющие центры играют ключевую роль в создании инфраструктуры открытых ключей (PKI), обеспечивающей безопасность и аутентификацию в Интернете. Они выполняют следующие функции:

- Генерация цифровых сертификатов: Когда владелец сайта хочет защитить свое соединение HTTPS, он создает запрос на получение сертификата (CSR) и направляет его в CA вместе с доказательством владения доменом.
- Проверка подлинности владельца ресурса: Прежде чем подписать сертификат, CA проводит проверку доменного имени и организации, владеющей ресурсом (это называется верификацией домена или расширенной проверкой EV Certificate).
- Создание цифровой подписи: После успешной проверки CA добавляет свою цифровую подпись к сертификату, подтверждая его валидность и доверие к владельцу ресурса.

Процесс выдачи сертификатов выглядит примерно так:

1. Администратор сервера создает пару ключей (открытый и закрытый ключи).
2. Генерирует CSR-запрос, включающий публичный ключ и необходимую информацию о владельце ресурса.
3. Отправляет CSR в CA.
4. CA проверяет запрашиваемого владельца ресурса и подписывает полученный сертификат своим приватным ключом.
5. Сертифицированный документ возвращается администратору сервера.

Полученный сертификат теперь подписан удостоверяющим центром и считается легитимным.


# Механизм проверки сертификата
Вот шаги, которые происходят при обращении клиента к защищенному сайту:

a. Клиент подключается к серверу и инициирует TLS Handshake.
b. Сервер предоставляет свой SSL/TLS-сертификат.
c. Браузер проверяет цепочку сертификатов:

Получив сертификат, браузер смотрит на подпись удостоверяющего центра.
Проверяет, находится ли корневой сертификат в списке доверенных.
Анализирует срок действия сертификата, наличие отзыва (через OCSP или CRL).
d. Если все успешно прошло, начинается обмен сессионными ключами для шифрования последующих сообщений.

Практический пример
Рассмотрим реальный сценарий обращения к сайту google.ru:

Ваш браузер соединяется с серверами Google по протоколу HTTPS.
Google предоставляет своему браузеру SSL/TLS-сертификат, подтверждающий владение доменом google.ru.
Ваш браузер проверяет сертификат:
Сравнивает его подпись с известными корневыми сертификатами (Google использует сертифицирующие центры, такие как GlobalSign или Digicert).
Убедившись в верности сертификата, устанавливает безопасное соединение.
Таким образом, удостоверения центров и хранение корневых сертификатов являются фундаментальным элементом надежной и безопасной передачи данных в сети Интернет.

#####################################################################################################################################################

# Example if you want your own domain with https
(with Let’s Encrypt)

▌ Шаг 1. Покупка домена и открытие порта 443

Предположим, вы купили домен my-super-site.ru. Далее:

- Открываем порт 443 (стандартный порт для HTTPS-трафика) на вашем сервере.
- Настроили DNS записи таким образом, чтобы IP адрес вашего сервера соответствовал домену.

▌ Шаг 2. Генерация закрытого ключа и CSR

Для начала нам потребуется сгенерировать два файла:

1. Закрытый ключ (private key) — секретный ключ, который будет использоваться исключительно вами для расшифровки трафика.
2. Запрос на выдачу сертификата (CSR) — публичный запрос, который отправляется в удостоверяющий центр (CA) для подписи.

▌ Создание закрытого ключа и CSR с помощью OpenSSL:

1. Сначала создаем закрытый ключ RSA длиной 2048 бит:

openssl genrsa -out private.key 2048
Этот файл private.key хранит ваш закрытый ключ и должен оставаться абсолютно секретным.

2. Затем формируем CSR-файл (certificate signing request), который будет отправлен удостоверяющему центру:

openssl req -new -key private.key -out certificate.csr
Вас попросят ввести некоторые данные:

- Common Name (CN): your domain (например, my-super-site.ru)
- Country Name (C): RU
- State or Province Name (ST): Moscow
- Locality Name (L): Moscow
- Organization Name (O): My Super Company
- Organizational Unit Name (OU): IT Department
- Email Address: admin@my-super-site.ru

▌ Шаг 3. Получение сертификата от удостоверяющего центра

Существует несколько вариантов получения сертификата:

1. Платные коммерческие решения (GlobalSign, DigiCert и др.)
2. Бесплатные автоматические решения (Let’s Encrypt)

Мы рассмотрим второй вариант, так как он прост и удобен.

▌ Получение сертификата через Let’s Encrypt:

Используем инструмент Certbot (официальный клиент для Let’s Encrypt):

1. Установите Certbot на своем сервере (например, на Ubuntu):

Bash

sudo apt install certbot python3-certbot-nginx
2. Запускаем команду для автоматического получения сертификата и конфигурирования Nginx:

Bash

sudo certbot --nginx -d my-super-site.ru
Эта команда сделает следующее:

- Автоматически получит бесплатный сертификат от Let’s Encrypt.
- Конфигурирует ваш Nginx для поддержки HTTPS.
- Включит автоматическое продление сертификата каждые 90 дней.

▌ Шаг 4. Установка сертификата и настройка Nginx

Если вы использовали ручной метод (OpenSSL и Let’s Encrypt) и получили файлы сертификата, выполните следующие шаги:

1. Переместите полученные файлы сертификата и закрытого ключа в каталог /etc/nginx/ssl:

Bash

sudo mkdir /etc/nginx/ssl
sudo cp fullchain.pem /etc/nginx/ssl/my-super-site.ru-fullchain.pem
sudo cp privkey.pem /etc/nginx/ssl/my-super-site.ru-privkey.pem
2. Изменяем конфигурационный файл Nginx для включения HTTPS:

Откройте файл вашей виртуальной хост-конфигурации (например, /etc/nginx/sites-enabled/default) и добавьте следующую секцию:

nginx

server {
    listen 443 ssl http2;
    server_name my-super-site.ru www.my-super-site.ru;

    ssl_certificate /etc/nginx/ssl/my-super-site.ru-fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/my-super-site.ru-privkey.pem;

    location / {
        root /var/www/html;
        index index.html index.htm;
    }
}
3. Перезапускаем Nginx:

Bash

sudo systemctl restart nginx
▌ Итоговая схема работы:

1. Посетитель вводит адрес https://my-super-site.ru
2. Бразуер отправляет запрос вашему серверу на порт 443.
3. Сервер принимает запрос и передает сертификат, подписанный удостоверяющим центром (Let’s Encrypt).
4. Браузер проверяет сертификат, убеждается в его валидности и устанавливает зашифрованное соединение.
5. Передача данных идет по защищённому каналу HTTPS.
